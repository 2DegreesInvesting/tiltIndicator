---
title: "Using real data"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article uses the tiltIndicator package with real data as described in [this issue](https://github.com/2DegreesInvesting/tiltIndicator/issues/160).

```{r setup}
library(dplyr, warn.conflicts = FALSE)
library(tidyr)
library(readr)
library(fs)
library(tiltIndicator)

packageVersion("tiltIndicator")

options(readr.show_col_types = FALSE)
```

> All data for pstr and pctr are in the folder "pstr_pctr_data". 

```{r}
# Help access the data
data_path <- function(...) {
  path_home("Downloads", "data_prep_v1", "pstr_pctr_data", ...)
}
```

> Only consider those that start with pstr_ or pctr_.

```{r}
to_consider <- "pstr_|pctr_"
all_files <- dir_ls(data_path())
useful_files <- all_files[grepl(to_consider, path_file(all_files))]

path_file(useful_files)
```

Read the useful file into a list of `real` data.

```{r}
real <- lapply(useful_files, read_csv) |>
  setNames(path_ext_remove(path_file(useful_files)))

real
```

### PCTR

> The datasets `pctr_companies` and `pctr_ecoinvent_co2` are in the exact same
format as in the mvp

```{r}
glimpse(real$pctr_ecoinvent_co2)

glimpse(real$pctr_companies)
```

Works smoothly.

```{r}
pctr <- real$pctr_ecoinvent_co2 |>
  pctr_score_activities() |>
  pctr_score_companies(real$pctr_companies)

pctr
```

### PSTR

### New functions

```{r}
# R/pstr_add_reductions_old.R
pstr_add_FIXME_reductions_new <- function(companies, scenario) {
  left_join(
    companies, scenario,
    by = join_by(type, sector, subsector),
    relationship = "many-to-many"
  )
}

# R/pstr_prepare_scenario.R
pstr_prepare_scenario <- function(ipr, weo) {
  bind_rows(
    pstr_prepare_scenario_impl(ipr, "ipr"),
    pstr_prepare_scenario_impl(weo, "weo")
  )
}
pstr_prepare_scenario_impl <- function(data, type) {
  data |>
    lowercase_characters() |>
    rename_with(~ gsub(paste0(type, "_"), "", .x)) |>
    mutate(type = type) |>
    rename(reductions = co2_reductions)
}

# R/pstr_prepare_companies.R
pstr_prepare_companies <- function(data) {
  data |>
    merge_scenario_columns() |>
    lowercase_characters() |>
    pivot_type_sector_subsector()
}

merge_scenario_columns <- function(data) {
  data |>
    mutate(ipr_sector = if_else(is.na(ipr_sector.y), ipr_sector.x, ipr_sector.y)) |>
    mutate(ipr_subsector = if_else(is.na(ipr_subsector.y), ipr_subsector.x, ipr_subsector.y)) |>
    mutate(weo_product = if_else(is.na(weo_product.y), weo_product.x, weo_product.y)) |>
    mutate(weo_flow = if_else(is.na(weo_flow.y), weo_flow.x, weo_flow.y)) |>
    select(-ends_with(".x")) |>
    select(-ends_with(".y")) |>
    distinct()
}

pivot_type_sector_subsector <- function(companies) {
  companies |>
    rename(weo_sector = weo_product, weo_subsector = weo_flow) |>
    pivot_longer(c(ipr_sector, ipr_subsector, weo_sector, weo_subsector)) |>
    separate(name, c("type", "tmp")) |>
    pivot_wider(names_from = "tmp")
}

# R/utils.R
lowercase_characters <- function(data) {
  mutate(data, across(where(is.character), tolower))
}
```

### Prepare data

```{r}
companies <- pstr_prepare_companies(real$pstr_companies)
scenario <- pstr_prepare_scenario(real$pstr_ipr_2022, real$pstr_weo_2022)
```

### Calculate the indicator

```{r}
companies |>
  pstr_add_FIXME_reductions_new(scenario) |>
  pstr_add_transition_risk() |>
  # FIXME: We lost `company_id`
  # FIXME: We lost `type`
  # FIXME: Remove groups
  pstr_aggregate_scores(companies)
```

QUESTION 1: De we expect only one type for some companies?

```{r}
companies |>
  slice(1) |>
  pstr_add_FIXME_reductions_new(scenario) |>
  pstr_add_transition_risk() |>
  count(type)
```

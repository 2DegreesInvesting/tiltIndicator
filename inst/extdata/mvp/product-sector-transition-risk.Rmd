---
title: "Product sector transition risk"
author: "Linda Delacombaz"
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### Setup

Packages

```{r}
library(ggplot2, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(readr, warn.conflicts = FALSE)
library(tiltIndicator)
```

### Functions

To be done

### Data

1. Demo companies toy data set that has the company name along with its
products, sector and subsector information.

```{r}
demo_companies <- tiltIndicator::companies

demo_companies
```

2. Mapper, which serves as a sector classification bridge between the
Europages' sectors and subsectors and the WEO 2022 file.

```{r}
ep_weo_mapper <- tiltIndicator::ep_weo

summary(ep_weo_mapper)
```

3. WEO file that contains the scenario, year, product and reductions
information.

```{r}
weo_2022 <- tiltIndicator::weo_2022

weo_2022
```

# Analysis

## Introduction

The Product Sector Transition Risk Indicator measures the transition risk of
products based on the sector’s emissions targets the product belongs to. Those
sector emission reduction targets vary across scenarios (e.g., net zero
scenario or 1.5° scenario) and the time horizon (e.g., reduction needed in
2030, 2040, 2050 to achieve the targets).

After assessing each product, all the products with the same category will be
aggregated and set in relation to all products of the company. We, therefore,
derive company-level information.

The goal of the transition risk MVP is to create a first draft of how the
transition risk indicator would be build in code in order to convert it into
code production easily in the future.

The transition risk indicator consists of 4 main steps:

-   Step 1: Matching the products to the sectors
-   Step 2: Identifying sector-specific emission reduction targets
-   Step 3: Categorizing sector emission reduction targets into high,
    medium, and low product sector transition risk
-   Step 4: Aggregating on the company-level

## Step 1: Matching the products to the sectors

Each product of the company will be matched to a climate-relevant sector. For
those that cannot be matched to one of the sectors, we classify them as
‘Other’.

Let us print the demo companies toy data set that has the company name along
with its products, sector and subsector information.

```{r}
demo_companies
```

Let us print the mapper, which serves as a sector classification bridge between
the Europages' sectors and subsectors and the WEO 2022 file.

```{r}
ep_weo_mapper
```

We join this on the sectors and subsectors columns.

```{r}
joined_df <- demo_companies |>
  left_join(ep_weo_mapper, by = c("sector" = "EP_sector", "subsector" = "EP_subsector"))

joined_df
```

## Step 2: Identifying sector-specific emission reduction targets

Let us print the WEO file that contains the scenario, year, product and
reductions information.

```{r}
weo_2022
```

Let's join that again with our previously joined data frame:

```{r}
final_df <- joined_df |>
  left_join(weo_2022, by = c("weo_product_mapper" = "product", "weo_flow_mapper" = "flow"))

final_df

final_df
```

## Step 3: Categorizing sector emission reduction targets into high, medium, and low product sector transition risk

Let us categorize the transition risk into low, medium and high risk, based on
the value of the reductions.

-   reductions ≤ 30% means low product sector transition risk.

-   30% \< reductions ≤ 70% means medium product sector transition risk.

-   reductions \> 70% means high product sector transition risk.

```{r}
final_df_cat <- final_df |>
   mutate(
     transition_risk = case_when(
       reductions <= 30 ~ "low",
       reductions > 30 & reductions <= 70 ~ "medium",
       reductions >= 70 ~ "high",
       TRUE ~ "no_sector",
       )
     )

final_df_cat

final_df_cat
```

## Step 4: Aggregating on the company-level

To derive a company-level indicator for a company that has more than one
product in its portfolio, it is necessary to aggregate the Product sector
transition Risk Indicator of each product into one indicator. The proposed
method for that is to assume the same weights for each product.

Here are the calculation rules:

-   High Sector Transition Risk Products (in %) = ∑ of all high sector
    transition risk products / ∑ of all products

-   Medium Sector Transition Risk Products (in %) = ∑ of all medium
    sector transition risk products / ∑ of all products

-   Low Sector Transition Risk Products (in %) = ∑ of all low sector
    transition risk products / ∑ of all products

-   No Sector Transition Risk Products (in %) = ∑ of all no sector
    transition risk products / ∑ of all products

Here I calculate the numbers of products per companies in a new column, and
join the data frame to have the data with the numbers of products that a
company produces.

```{r}
n_products_per_companies <- demo_companies |>
  group_by(company_name) |>
  summarise(total_products_per_company = n())
```

```{r}
final_df_cat <- final_df_cat |>
  left_join(n_products_per_companies, by = 'company_name')

final_df_cat
```

Then, I calculate the score aggregated by summing (per transition risk) the
products over the total numbers of products per company.

```{r}
aggregated_score_df <- final_df_cat |>
  select(company_id, company_name, transition_risk, total_products_per_company, scenario, year) |>
  group_by(company_name, transition_risk, scenario, year) |>
  summarise(score_aggregated = (n()/total_products_per_company*100), .groups = 'keep') |>
  distinct_all()

aggregated_score_df

aggregated_score_df
```

## Step 5: Vizualisation example

Let us plot the result for the Peasant Peter company.

The score aggregated is the percentage of products of that company that are in
either low, medium or high transition risk, relatively to a scenario and year
that the user could chose, for example.

```{r}
level_order <- c('low', 'medium', 'high')

aggregated_score_df  |>
  filter(company_name == "Peasant Peter") |>
  ggplot(aes(x = transition_risk, y = score_aggregated, fill = score_aggregated)) +
  scale_x_discrete(limits = level_order) +
  geom_col() +
  scale_fill_gradient2(midpoint = 0, low = "red", high = "blue") +
  facet_grid(company_name ~ scenario+year)
```

---
title: "Product sector transition risk"
author: "Linda Delacombaz"
output: github_document
params:
  input1: NULL
  input2: NULL
  input3: NULL
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### Setup

Packages

```{r}
library(ggplot2, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(rlang)
library(tiltIndicator)
```

### Functions

To be done

### Data

```{r}
#' A dataset with fake companies, products, sectors and subsectors
#'
#' TODO: Does it have any relationship with tiltData?
#' TODO: Move this documetation to R/dataset-name.R and data-raw/dataset-name.R
#' FIXME: Rename to match existing tiltData, e.g. `company_id` -> `companies_id`
companies <- params$input1 %||% tiltIndicator::companies |> glimpse()

#' A bridge between sector and subsectors in europages and in `weo_2022`.
#'
#' TODO: Where does it come from and what wrangling did you do?
#' TODO: Move this documetation to R/dataset-name.R and data-raw/dataset-name.R
#' FIXME: Rename to match existing tiltData and to use lowercase. E.g.
#' removing the prefix "ep_" makes it more compatible with tiltData
#' and makes it easier to join here.
ep_weo <- params$input2 %||% tiltIndicator::ep_weo |> glimpse()

#' A dataset with scenario, year, product and reductions information
#'
#' TODO: Where does it come from and what wrangling did you do?
#' TODO: Move this documetation to R/dataset-name.R and data-raw/dataset-name.R
weo_2022 <- params$input3 %||% tiltIndicator::weo_2022 |> glimpse()
```

# Analysis

## Introduction

The Product Sector Transition Risk Indicator measures the transition risk of
products based on the sector’s emissions targets the product belongs to. Those
sector emission reduction targets vary across scenarios (e.g., net zero
scenario or 1.5° scenario) and the time horizon (e.g., reduction needed in
2030, 2040, 2050 to achieve the targets).

After assessing each product, all the products with the same category will be
aggregated and set in relation to all products of the company. We, therefore,
derive company-level information.

The goal of the transition risk MVP is to create a first draft of how the
transition risk indicator would be build in code in order to convert it into
code production easily in the future.

The transition risk indicator consists of 4 main steps:

-   Step 1: Matching the products to the sectors
-   Step 2: Identifying sector-specific emission reduction targets
-   Step 3: Categorizing sector emission reduction targets into high,
    medium, and low product sector transition risk
-   Step 4: Aggregating on the company-level

## Step 1 and 2

1. Matching the products to the sectors
2. Identifying sector-specific emission reduction targets

Each product of the company will be matched to a climate-relevant sector. For
those that cannot be matched to one of the sectors, we classify them as ‘Other’.

We join this on the sectors and subsectors columns.

```{r}
# TODO: Complete documentation
#' Title
#'
#' @param companies 
#' @param ep_weo 
#' @param weo_2022 
#'
#' @return
#' @export
#'
#' @examples
pstr_add_reductions <- function(companies, ep_weo, weo_2022) {
  companies |>
    left_join(ep_weo, by = c("sector" = "EP_sector", "subsector" = "EP_subsector")) |> 
    left_join(weo_2022, by = c("weo_product_mapper" = "product", "weo_flow_mapper" = "flow"))
}

# FIXME: Do what the warning says
with_reductions <- pstr_add_reductions(companies, ep_weo, weo_2022)

with_reductions
```

## Step 3: Categorizing sector emission reduction targets into high, medium, and low product sector transition risk

Let us categorize the transition risk into low, medium and high risk, based on
the value of the reductions.

-   reductions ≤ 30% means low product sector transition risk.

-   30% \< reductions ≤ 70% means medium product sector transition risk.

-   reductions \> 70% means high product sector transition risk.

```{r}
# TODO: Complete documentation
#' Title
#'
#' @param data A data frame. The ouptput of [pstr_add_reductions()].
#'
#' @return
#' @export
#'
#' @examples
pstr_add_transition_risk <- function(data) {
  data |>
    mutate(
      transition_risk = case_when(
        reductions <= 30 ~ "low",
        reductions > 30 & reductions <= 70 ~ "medium",
        reductions >= 70 ~ "high",
        TRUE ~ "no_sector",
      )
    )
}

with_transition_risk <- pstr_add_transition_risk(with_reductions)

with_transition_risk
```

## Step 4: Aggregating on the company-level

To derive a company-level indicator for a company that has more than one
product in its portfolio, it is necessary to aggregate the Product sector
transition Risk Indicator of each product into one indicator. The proposed
method for that is to assume the same weights for each product.

Here are the calculation rules:

-   High Sector Transition Risk Products (in %) = ∑ of all high sector
    transition risk products / ∑ of all products

-   Medium Sector Transition Risk Products (in %) = ∑ of all medium
    sector transition risk products / ∑ of all products

-   Low Sector Transition Risk Products (in %) = ∑ of all low sector
    transition risk products / ∑ of all products

-   No Sector Transition Risk Products (in %) = ∑ of all no sector
    transition risk products / ∑ of all products

Here I calculate the numbers of products per companies in a new column, and join
the data frame to have the data with the numbers of products that a company
produces.

Then, I calculate the score aggregated by summing (per transition risk) the
products over the total numbers of products per company.

```{r}
# TODO: Complete documentation
#' Title
#'
#' @param data A data frame. The ouptput of [pstr_add_transition_risk()].
#'
#' @return
#' @export
#'
#' @examples
pstr_aggregate_scores <- function(data) {
  n_products_per_companies <- companies |>
    group_by(company_name) |>
    summarise(total_products_per_company = n())
  
  with_transition_risk2 <- data |>
    left_join(n_products_per_companies, by = "company_name")
  
  with_transition_risk2 |>
    select(company_id, company_name, transition_risk, total_products_per_company, scenario, year) |>
    group_by(company_name, transition_risk, scenario, year) |>
    summarise(score_aggregated = (n() / total_products_per_company * 100), .groups = "keep") |>
    distinct_all()
}

with_score_aggregated <- pstr_aggregate_scores(with_transition_risk)

with_score_aggregated
```

## Step 5: Vizualisation example

Let us plot the result for the Peasant Peter company.

The score aggregated is the percentage of products of that company that are in
either low, medium or high transition risk, relatively to a scenario and year
that the user could chose, for example.

```{r}
# TODO: Complete documentation
#' Title
#'
#' @param data A data frame. The ouptput of [pstr_aggregate_scores()].
#'
#' @return
#' @export
#'
#' @examples
pstr_plot_company <- function(with_score_aggregated) {
  level_order <- c("low", "medium", "high")
  
  with_score_aggregated |>
    filter(company_name == "Peasant Peter") |>
    ggplot(aes(x = transition_risk, y = score_aggregated, fill = score_aggregated)) +
    scale_x_discrete(limits = level_order) +
    geom_col() +
    scale_fill_gradient2(midpoint = 0, low = "red", high = "blue") +
    facet_grid(company_name ~ scenario + year)
}

pstr_plot_company(with_score_aggregated)
```

---
title: "Product carbon transition risk (PCTR)"
author: "Tilman Trompke"
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

# Setup

Packages

```{r}
library(dplyr, warn.conflicts = FALSE)
library(tiltIndicator)
```

The tiltIndicator package comes with example datasets for the PCTR indicator.

```{r}
ecoinvent_co2 <- pctr_ecoinvent_co2 |> glimpse()

companies <- pctr_companies |> glimpse()
```

#  Analysis

## Introduction

The Product Carbon Transition Risk measures the transition risk on the product-level of a company. The indicator is expressed in the percentage of all products that are at high risk, medium risk or low risk due to the products’ relative carbon footprint. The assessment is first performed on a product-level and can then be aggregated to the company-level.

The Product Carbon Transition Risk measures the relative carbon footprint per product. As a default option each product will be compared to the carbon footprint of every other product. Alternatively, users can also choose to compare those products of the same type, so e.g., comparing only raw materials with each other. Products with a higher carbon-footprint will also face a higher risk.

After identifying each carbon footprint for one product, the products will be ranked according to their carbon footprint. Products in the highest percentile (≥70%) will be classified as high transition risk products. Products in the medium percentile (between ≥30% and <70%) will be classified as medium transition risk products. Products in the lowest percentile (<30%) will be classified as low transition risk products.

After categorisation, we will aggregate all products from the same category and set them in relation to all products that the company produces. We derive the Product Carbon Transition Risks.

Please note that carbon footprints, and emissions are used equivalently. Carbon footprint refers only on the emissions which occur at the production stage of the product and not the emissions from the inputs. The unit is CO2e in kg.

The goal of the transition risk MVP is to create a first draft of how the transition risk indicator for products would be build in code in order to convert it into code production easily in the future. This MVP should provide the share of products with "low", "medium", or "high" relative production emissions per company.

In this markdown file the aim is to prepare data so that they contain the following:

- a column with production emissions
- a column indicating the percentile relative to (i) all products with same unit (ii) products in same sector (iii) products in same segment
- a column indicating whether the product has "low", "medium" or "high" relative production emissions

The product carbon transition risk indicator consists of 2 main steps:

- Step 1: Score activities
- Step 2: Score companies

## Score activities

Sub-steps:

* Calculate the rank of each activity: This is done based on the activities'
carbon footprint compared to 3 different benchmarks (all products, products with
same unit, products with same unit and sector)

* Assign scores to the activities: This is done based on their position within the
distribution of co2 footprints in comparison to different benchmarks.

```{r}
pctr_score_activities <- function(ecoinvent_co2, low_threshold, high_threshold){
  ecoinvent_co2 |> 
    pctr_add_ranks() |> 
    pctr_add_scores(low_threshold, high_threshold)
}

# rank in comparison to all products
pctr_add_ranks <- function(ecoinvent_co2) {
  # FIXME: "perc" suggests "percent" but "proportion" seems more accurate. Also
  # if the main goal is to rank, then maybe the columns should use the prefix
  # `rank_*` instead. Or maybe the goal is not to calculate the ranks, in which
  # case we need a different title?
  ecoinvent_co2 |>
    mutate(perc_all = rank(co2_footprint) / length(co2_footprint)) |> 
    # rank in comparison to all products with same unit
    group_by(unit) |>
    mutate(perc_unit = rank(co2_footprint) / length(co2_footprint)) %>%
    ungroup() |> 
    # rank in comparison to all products with same unit and sector
    group_by(unit, sec) |>
    mutate(perc_unit_sec = rank(co2_footprint) / length(co2_footprint)) %>%
    ungroup()
}

# assign scores to position within percentile distribution
# for all products
pctr_add_scores <- function(ecoinvent_ranks, low_threshold, high_threshold) {
  ecoinvent_ranks %>%
    mutate(
      score_all = case_when(
        perc_all < low_threshold ~ "low",
        perc_all >= low_threshold & perc_all < high_threshold ~ "medium",
        perc_all >= high_threshold ~ "high"
      )
    ) |> 
    # for products with same unit
    mutate(
      score_unit = case_when(
        perc_unit < low_threshold ~ "low",
        perc_unit >= low_threshold & perc_unit < high_threshold ~ "medium",
        perc_unit >= low_threshold ~ "high"
      )
    ) |> 
    # for products with same unit and sector
    mutate(
      score_unit_sec = case_when(
        perc_unit_sec < low_threshold ~ "low",
        perc_unit_sec >= low_threshold & perc_unit_sec < high_threshold ~ "medium",
        perc_unit_sec >= high_threshold ~ "high",
      )
    )
}
```

```{r}
ecoinvent_ranks <- pctr_add_ranks(ecoinvent_co2)
ecoinvent_ranks

# ecoinvent_scores <- ecoinvent_ranks |> 
#   pctr_add_scores(low_threshold = 0.3, high_threshold = 0.7)

ecoinvent_scores <- ecoinvent_co2 |> 
  pctr_score_activities(low_threshold = 0.3, high_threshold = 0.7)
```

Show distributions

```{r}
barplot(prop.table(table(ecoinvent_scores$score_all)))
barplot(prop.table(table(ecoinvent_scores$score_unit)))
barplot(prop.table(table(ecoinvent_scores$score_unit_sec)))
```

## Score companies

The final dataset should have three rows per company, i.e. one for each
risk_group (low, medium, high) and one column each indicating the share of
products in the respective risk groups for the three different benchmarks (all
products, products with same unit, products with same unit and sector).

Intermediate steps:

* Combine company-level information with LCA info from ecoinvent.
* Calculate the share of products with each score.

```{r}
pctr_score_companies <- function(companies, ecoinvent_scores) {
  # join by activity_product_uuid and other joint columns from companies with ecoinvent_scores
  companies_scores <- companies |>
    inner_join(ecoinvent_scores, by = c("activity_product_uuid", "ei_activity", "unit"))
  
  
  
  # scores in comparison to all products
  scores_all <- companies_scores |>
    group_by(company_id, score_all) |>
    summarise(n_all = n()) |>
    mutate(share_all = n_all / sum(n_all)) |>
    select(-n_all) |>
    rename("score" = "score_all")
  
  # scores in comparison to products with same unit
  scores_unit <- companies_scores |>
    group_by(company_id, score_unit) |>
    summarise(n_unit = n()) |>
    mutate(share_unit = n_unit / sum(n_unit)) |>
    select(-n_unit) |>
    rename("score" = "score_unit")
  
  # scores in comparison to products with same unit and sector
  scores_unit_sec <- companies_scores |>
    group_by(company_id, score_unit_sec) |>
    summarise(n_unit_sec = n()) |>
    mutate(share_unit_sec = n_unit_sec / sum(n_unit_sec)) |>
    select(-n_unit_sec) |>
    rename("score" = "score_unit_sec")
  
  # create dataset sceleton
  dt_sceleton <- tibble(
    company_id = rep(unique(companies_scores$company_id), each = 3),
    score = rep(c("high", "medium", "low"), 3),
  )
  
  # join scores with dt_sceleton so that each company is shown with 3 rows for low, medium, and high, even if the share is 0.
  pctr_output <- dt_sceleton |>
    left_join(scores_all, by = c("company_id", "score")) |>
    left_join(scores_unit, by = c("company_id", "score")) |>
    left_join(scores_unit_sec, by = c("company_id", "score"))
  
  # replace NAs with 0
  pctr_output <- pctr_output |>
    replace(is.na(pctr_output), 0)
}

pctr_output <- pctr_score_companies(companies, ecoinvent_scores)
pctr_output
```
